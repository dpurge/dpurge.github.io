<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  VPC
  #

VPC = Virtual Private Cloud
VPC is a virtualized, software defined network within Google Cloud.
VPC network, its routes and firewall rules are global resources, not associated with any particular region or zone.
VPC is encapsulated within a project.
VPCs do not have any IP address ranges associated with them.
IP adress ranges are defined within subnetworks associated with VPC.
Subnetworks are regional.
Network firewall rules control traffic flowing in and out of the VPC."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://dpurge.github.io/docs/devops/gcp/vpc/"><meta property="og:site_name" content="Notebook"><meta property="og:title" content="Notebook"><meta property="og:description" content="VPC # VPC = Virtual Private Cloud
VPC is a virtualized, software defined network within Google Cloud.
VPC network, its routes and firewall rules are global resources, not associated with any particular region or zone.
VPC is encapsulated within a project.
VPCs do not have any IP address ranges associated with them. IP adress ranges are defined within subnetworks associated with VPC. Subnetworks are regional.
Network firewall rules control traffic flowing in and out of the VPC."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2024-11-08T17:10:40+01:00"><title>Vpc | Notebook</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.0fe3d81805de7f5a7b09de616e3724ea45f869d4bb2f1a5a96e2f23079f334b0.css integrity="sha256-D+PYGAXef1p7Cd5hbjck6kX4adS7LxpaluLyMHnzNLA=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script><script defer src=/en.search.min.ecd2bd629e75f77edd32d7b0d0b7b02aac693f20fe182cdd50ce323d1ec68979.js integrity="sha256-7NK9Yp51937dMtew0LewKqxpPyD+GCzdUM4yPR7GiXk=" crossorigin=anonymous></script><script defer src=/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js integrity="sha256-b2+Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC+NdcPIvZhzk=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Notebook</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><input type=checkbox id=section-5ed42fa188b10ac098d312d036e5db61 class=toggle checked>
<label for=section-5ed42fa188b10ac098d312d036e5db61 class="flex justify-between"><a role=button>Devops</a></label><ul><li><input type=checkbox id=section-1fcf73664521c60a632dd1a03efd1f51 class=toggle>
<label for=section-1fcf73664521c60a632dd1a03efd1f51 class="flex justify-between"><a role=button>Ansible</a></label><ul><li><a href=/docs/devops/ansible/installation/>Installation</a></li></ul></li><li><input type=checkbox id=section-c2087d1a0cdf1643f70cd556cb17ad55 class=toggle>
<label for=section-c2087d1a0cdf1643f70cd556cb17ad55 class="flex justify-between"><a role=button>ArgoCD</a></label><ul><li><a href=/docs/devops/argo/installation/>Installation</a></li></ul></li><li><input type=checkbox id=section-f47ce4ece0f3dbd0b0d5520f3ec152ac class=toggle>
<label for=section-f47ce4ece0f3dbd0b0d5520f3ec152ac class="flex justify-between"><a href=/docs/devops/aws/>AWS</a></label><ul><li><a href=/docs/devops/aws/architecture/>Architecture</a></li><li><a href=/docs/devops/aws/aws-cli/>Aws CLI</a></li></ul></li><li><input type=checkbox id=section-6be09103bf6e030c155008595e01da99 class=toggle>
<label for=section-6be09103bf6e030c155008595e01da99 class="flex justify-between"><a role=button>Azure</a></label><ul><li><a href=/docs/devops/azure/exploring/>Exploring</a></li><li><a href=/docs/devops/azure/snippets/>Snippets</a></li></ul></li><li><input type=checkbox id=section-3582c732c4f454b4276fc327f0f84b75 class=toggle>
<label for=section-3582c732c4f454b4276fc327f0f84b75 class="flex justify-between"><a role=button>Blueprints</a></label><ul><li><a href=/docs/devops/blueprints/aws-3tier-webapp/>Aws 3tier Webapp</a></li><li><a href=/docs/devops/blueprints/aws-static-webapp/>Aws Static Webapp</a></li><li><a href=/docs/devops/blueprints/llm-closed-source/>Llm Closed Source</a></li></ul></li><li><input type=checkbox id=section-d17d00db7ed57a932813a4cfe8bef2c9 class=toggle>
<label for=section-d17d00db7ed57a932813a4cfe8bef2c9 class="flex justify-between"><a role=button>Docker</a></label><ul><li><a href=/docs/devops/docker/azure/>Azure</a></li><li><a href=/docs/devops/docker/basics/>Basics</a></li><li><a href=/docs/devops/docker/compose/>Compose</a></li><li><a href=/docs/devops/docker/installation/>Installation</a></li><li><a href=/docs/devops/docker/volumes/>Volumes</a></li></ul></li><li><input type=checkbox id=section-3a5deda6c7b3589dca066456e5c769e5 class=toggle checked>
<label for=section-3a5deda6c7b3589dca066456e5c769e5 class="flex justify-between"><a role=button>GCP</a></label><ul><li><a href=/docs/devops/gcp/cloud-shell/>Cloud Shell</a></li><li><a href=/docs/devops/gcp/definitions/>Definitions</a></li><li><a href=/docs/devops/gcp/firewall/>Firewall</a></li><li><a href=/docs/devops/gcp/functions/>Functions</a></li><li><a href=/docs/devops/gcp/gcloud/>Gcloud</a></li><li><a href=/docs/devops/gcp/gke-workload-identity/>Gke Workload Identity</a></li><li><a href=/docs/devops/gcp/gke/>Gke</a></li><li><a href=/docs/devops/gcp/iam/>Iam</a></li><li><a href=/docs/devops/gcp/networking/>Networking</a></li><li><a href=/docs/devops/gcp/vpc/ class=active>Vpc</a></li></ul></li><li><input type=checkbox id=section-9974b9802269f61682fb29dcad8dd329 class=toggle>
<label for=section-9974b9802269f61682fb29dcad8dd329 class="flex justify-between"><a role=button>Git</a></label><ul><li><a href=/docs/devops/git/branches/>Branches</a></li><li><a href=/docs/devops/git/configuration/>Configuration</a></li></ul></li><li><input type=checkbox id=section-64c3362c9e54d04fb3d47417b1fd82a3 class=toggle>
<label for=section-64c3362c9e54d04fb3d47417b1fd82a3 class="flex justify-between"><a role=button>Helm</a></label><ul><li><a href=/docs/devops/helm/charts/>Charts</a></li><li><a href=/docs/devops/helm/installation/>Installation</a></li></ul></li><li><input type=checkbox id=section-b998ae67e90826b64ad2b5c3cda70e97 class=toggle>
<label for=section-b998ae67e90826b64ad2b5c3cda70e97 class="flex justify-between"><a role=button>K3s</a></label><ul><li><a href=/docs/devops/k3s/k3d/>K3d</a></li><li><a href=/docs/devops/k3s/k3s/>K3s</a></li></ul></li><li><input type=checkbox id=section-6f0fb928174eee68ae46a2b065a10d98 class=toggle>
<label for=section-6f0fb928174eee68ae46a2b065a10d98 class="flex justify-between"><a href=/docs/devops/kubernetes/>Kubernetes</a></label><ul><li><a href=/docs/devops/kubernetes/azure-kubernetes/>Azure Kubernetes</a></li><li><a href=/docs/devops/kubernetes/deployment/>Deployment</a></li><li><a href=/docs/devops/kubernetes/design-patterns/>Design Patterns</a></li><li><a href=/docs/devops/kubernetes/ingress/>Ingress</a></li><li><a href=/docs/devops/kubernetes/k9s/>K9s</a></li><li><a href=/docs/devops/kubernetes/kubectl-config/>Kubectl Config</a></li><li><a href=/docs/devops/kubernetes/minikube/>Minikube</a></li><li><a href=/docs/devops/kubernetes/pod/>Pod</a></li><li><a href=/docs/devops/kubernetes/replica-set/>Replica Set</a></li><li><a href=/docs/devops/kubernetes/sealed-secrets/>Sealed Secrets</a></li><li><a href=/docs/devops/kubernetes/service/>Service</a></li><li><a href=/docs/devops/kubernetes/short-names/>Short Names</a></li></ul></li><li><input type=checkbox id=section-47a6b9cf18ba8fd999da8a767a80d55c class=toggle>
<label for=section-47a6b9cf18ba8fd999da8a767a80d55c class="flex justify-between"><a role=button>Linux</a></label><ul><li><a href=/docs/devops/linux/blocky/>Blocky</a></li><li><a href=/docs/devops/linux/caddy/>Caddy</a></li><li><a href=/docs/devops/linux/podman/>Podman</a></li><li><a href=/docs/devops/linux/screen/>Screen</a></li><li><a href=/docs/devops/linux/searxng/>Searxng</a></li><li><a href=/docs/devops/linux/setup/>Setup</a></li><li><a href=/docs/devops/linux/ubuntu/>Ubuntu</a></li></ul></li><li><input type=checkbox id=section-8c295e57838921fd2d675ad856381c28 class=toggle>
<label for=section-8c295e57838921fd2d675ad856381c28 class="flex justify-between"><a href=/docs/devops/macos/>MacOS</a></label><ul><li><a href=/docs/devops/macos/homebrew/>Homebrew</a></li><li><a href=/docs/devops/macos/java/>Java</a></li><li><a href=/docs/devops/macos/multipass/>Multipass</a></li><li><a href=/docs/devops/macos/python/>Python</a></li></ul></li><li><input type=checkbox id=section-10f7911111825950c64c7c1eaf3c1e76 class=toggle>
<label for=section-10f7911111825950c64c7c1eaf3c1e76 class="flex justify-between"><a href=/docs/devops/ollama/>Ollama</a></label><ul></ul></li><li><input type=checkbox id=section-d425dec9d097e6d0fb451b2000e12c4b class=toggle>
<label for=section-d425dec9d097e6d0fb451b2000e12c4b class="flex justify-between"><a role=button>Packer</a></label><ul><li><a href=/docs/devops/packer/installation/>Installation</a></li></ul></li><li><input type=checkbox id=section-61932fa60c5fb65e4442fb06867ba7dc class=toggle>
<label for=section-61932fa60c5fb65e4442fb06867ba7dc class="flex justify-between"><a href=/docs/devops/podman/>Podman</a></label><ul><li><a href=/docs/devops/podman/compose/>Compose</a></li></ul></li><li><input type=checkbox id=section-fe27198961b1e6e0429110142052b0d0 class=toggle>
<label for=section-fe27198961b1e6e0429110142052b0d0 class="flex justify-between"><a href=/docs/devops/qemu/>QEmu</a></label><ul></ul></li><li><input type=checkbox id=section-fc00d5feb946b8fb7e89a44043aaff38 class=toggle>
<label for=section-fc00d5feb946b8fb7e89a44043aaff38 class="flex justify-between"><a href=/docs/devops/terraform/>Terraform</a></label><ul><li><a href=/docs/devops/terraform/aws/>Aws</a></li><li><a href=/docs/devops/terraform/basics/>Basics</a></li><li><a href=/docs/devops/terraform/installation/>Installation</a></li></ul></li><li><input type=checkbox id=section-510829274d6159e3c9c28d13c09cfce3 class=toggle>
<label for=section-510829274d6159e3c9c28d13c09cfce3 class="flex justify-between"><a role=button>Terragrunt</a></label><ul><li><a href=/docs/devops/terragrunt/basics/>Basics</a></li></ul></li><li><input type=checkbox id=section-17240d63f82733a8ccdf6e48de5bc2d7 class=toggle>
<label for=section-17240d63f82733a8ccdf6e48de5bc2d7 class="flex justify-between"><a role=button>Vagrant</a></label><ul><li><a href=/docs/devops/vagrant/installation/>Installation</a></li></ul></li><li><input type=checkbox id=section-952ea06750cba9d3a9b5281dd2b01470 class=toggle>
<label for=section-952ea06750cba9d3a9b5281dd2b01470 class="flex justify-between"><a role=button>Windows</a></label><ul><li><a href=/docs/devops/windows/ime/>Ime</a></li><li><a href=/docs/devops/windows/winget/>Winget</a></li></ul></li><li><input type=checkbox id=section-8ee96527a880b8936288c158356afd2f class=toggle>
<label for=section-8ee96527a880b8936288c158356afd2f class="flex justify-between"><a role=button>WSL</a></label><ul><li><a href=/docs/devops/wsl/installation/>Installation</a></li><li><a href=/docs/devops/wsl/ubuntu2004/>Ubuntu2004</a></li><li><a href=/docs/devops/wsl/ubuntu2204/>Ubuntu2204</a></li></ul></li></ul></li><li><input type=checkbox id=section-a934983054f48baad52d2e7a3a399e50 class=toggle>
<label for=section-a934983054f48baad52d2e7a3a399e50 class="flex justify-between"><a role=button>Other</a></label><ul><li><input type=checkbox id=section-ec6a0b8566b72facd57e317d36f672ac class=toggle>
<label for=section-ec6a0b8566b72facd57e317d36f672ac class="flex justify-between"><a role=button>Books</a></label><ul><li><a href=/docs/other/books/snippets/>Snippets</a></li></ul></li></ul></li><li><input type=checkbox id=section-ac57b6c9cca771981a03b1ba45863f8d class=toggle>
<label for=section-ac57b6c9cca771981a03b1ba45863f8d class="flex justify-between"><a role=button>Tools</a></label><ul><li><input type=checkbox id=section-a45750650ff56d259f4062f438098a5a class=toggle>
<label for=section-a45750650ff56d259f4062f438098a5a class="flex justify-between"><a role=button>AzCLI</a></label><ul></ul></li><li><input type=checkbox id=section-4087f1b5bc81bf1d3302521293bf244b class=toggle>
<label for=section-4087f1b5bc81bf1d3302521293bf244b class="flex justify-between"><a role=button>GraphViz</a></label><ul></ul></li><li><input type=checkbox id=section-86e89c76906928d0f1ba213f94c31800 class=toggle>
<label for=section-86e89c76906928d0f1ba213f94c31800 class="flex justify-between"><a role=button>Tesseract</a></label><ul></ul></li></ul></li><li><input type=checkbox id=section-4404243c90aaf852c09add5b5557b400 class=toggle>
<label for=section-4404243c90aaf852c09add5b5557b400 class="flex justify-between"><a role=button>Programming</a></label><ul><li><input type=checkbox id=section-b7178fd2927c3e62d8a4e45fb55e60a7 class=toggle>
<label for=section-b7178fd2927c3e62d8a4e45fb55e60a7 class="flex justify-between"><a role=button>Awk</a></label><ul><li><a href=/docs/programming/awk/basics/>Basics</a></li></ul></li><li><input type=checkbox id=section-6cfd14a35e3949908c635cdeeacc0084 class=toggle>
<label for=section-6cfd14a35e3949908c635cdeeacc0084 class="flex justify-between"><a role=button>Bash</a></label><ul><li><a href=/docs/programming/bash/basics/>Basics</a></li></ul></li><li><input type=checkbox id=section-e5ff87ffd212150f3d29c33ed735f13e class=toggle>
<label for=section-e5ff87ffd212150f3d29c33ed735f13e class="flex justify-between"><a role=button>Batch</a></label><ul><li><a href=/docs/programming/batch/basics/>Basics</a></li></ul></li><li><input type=checkbox id=section-e5159efec64bdeff5e89f0d6097b0490 class=toggle>
<label for=section-e5159efec64bdeff5e89f0d6097b0490 class="flex justify-between"><a role=button>C#</a></label><ul><li><a href=/docs/programming/csharp/basics/>Basics</a></li></ul></li><li><input type=checkbox id=section-b0231b0e110de6fc607111305d8ab683 class=toggle>
<label for=section-b0231b0e110de6fc607111305d8ab683 class="flex justify-between"><a role=button>Go</a></label><ul><li><a href=/docs/programming/go/basics/>Basics</a></li><li><a href=/docs/programming/go/cgi/>Cgi</a></li><li><a href=/docs/programming/go/installation/>Installation</a></li></ul></li><li><input type=checkbox id=section-7d2d89e16c410986f302f6018a766478 class=toggle>
<label for=section-7d2d89e16c410986f302f6018a766478 class="flex justify-between"><a role=button>Powershell</a></label><ul><li><a href=/docs/programming/powershell/azdo/>Azdo</a></li><li><a href=/docs/programming/powershell/basics/>Basics</a></li><li><a href=/docs/programming/powershell/snippets/>Snippets</a></li></ul></li><li><input type=checkbox id=section-9574b6d1167d7327522b0f42bc5a4c8e class=toggle>
<label for=section-9574b6d1167d7327522b0f42bc5a4c8e class="flex justify-between"><a role=button>Python</a></label><ul><li><a href=/docs/programming/python/basics/>Basics</a></li><li><a href=/docs/programming/python/environment/>Environment</a></li><li><a href=/docs/programming/python/installation/>Installation</a></li></ul></li><li><input type=checkbox id=section-b02cfcac3355f9db66ee8423a9173bb3 class=toggle>
<label for=section-b02cfcac3355f9db66ee8423a9173bb3 class="flex justify-between"><a role=button>SQLite</a></label><ul><li><a href=/docs/programming/sqlite/data/>Data</a></li></ul></li><li><input type=checkbox id=section-90b0b18d2b29f7afc148bc24636416c6 class=toggle>
<label for=section-90b0b18d2b29f7afc148bc24636416c6 class="flex justify-between"><a role=button>Typescript</a></label><ul><li><a href=/docs/programming/typescript/nodejs/>Nodejs</a></li></ul></li></ul></li></ul><ul><li><a href=/posts/>Blog</a></li><li><a href=https://github.com/dpurge/dpurge.github.io target=_blank rel=noopener>Github</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu>
</label><strong>Vpc</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#vpc>VPC</a><ul><li><a href=#vpc-network-subnets>VPC network subnets</a><ul><li><a href=#ip-addresses-reserved-for-google>IP addresses reserved for Google</a></li></ul></li><li><a href=#routing-and-private-google-access>Routing and Private Google Access</a><ul><li><a href=#default-route>Default route</a></li><li><a href=#subnet-route>Subnet route</a></li><li><a href=#static-route>Static route</a></li><li><a href=#dynamic-route>Dynamic route</a></li></ul></li><li><a href=#create-vpc-with-gcloud>Create VPC with gcloud</a></li><li><a href=#create-vpc-with-terraform>Create VPC with terraform</a></li><li><a href=#vpc-with-private-google-access>VPC with Private Google Access</a></li><li><a href=#vpc-network-peering>VPC network peering</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=vpc>VPC
<a class=anchor href=#vpc>#</a></h1><p>VPC = Virtual Private Cloud</p><p>VPC is a virtualized, software defined network within Google Cloud.</p><p>VPC network, its routes and firewall rules are global resources, not associated with any particular region or zone.</p><p>VPC is encapsulated within a project.</p><p>VPCs do not have any IP address ranges associated with them.
IP adress ranges are defined within subnetworks associated with VPC.
Subnetworks are regional.</p><p>Network firewall rules control traffic flowing in and out of the VPC.</p><p>Resources within a VPC can communicate with one another by using their internal (priovate) IPv4 addresses.</p><p>VPCs only support IPv4 addresses (nodes can only send and receive IPv4 traffic).
It is possible to create IPv6 address for a global load balancer.</p><p>Each project comes with a default VPC network <code>10.128.0.0/9</code> that has a route to the default internet gateway and by default is in <em>auto mode</em>.
There are two network types: subnet creation <em>auto mode</em> or <em>custom mode</em>.</p><p><em>Auto mode</em> networks automatically create a <code>/20</code> subnet in each region.
As new regions become available, new subnets are automatically added.
Conversion from <em>auto mode</em> to <em>custom mode</em> is one-way.
You cannot convert back; <em>custom mode</em> networks cannot be changed back to <em>auto mode</em> mentworks.</p><p>Traffic cannot pass between separate networks unless you set up VPC peering or use a VPN connection.</p><h2 id=vpc-network-subnets>VPC network subnets
<a class=anchor href=#vpc-network-subnets>#</a></h2><p>A VPC network consists of one or more subnets; each subnet is associated with a region.</p><p>The name or region of a subnet cannot be changed after you have created it.
You have to delete a subnet (no resources may be using it) and create it again.</p><p>Primary and secondary ranges for subnets cannot overlap with any allocated range in other subnets or peered networks.</p><p>Subnet address range can be increased: it must not overlap with other subnets, must stay inside the RFC 1918 adress-space, must be larger than the original.
You cannot undo the expansion.
<code>/20</code> range can be expanded to the <code>/16</code> range, but not larger.
You have to convert to a <em>custom mode</em> to increase the range any further.</p><h3 id=ip-addresses-reserved-for-google>IP addresses reserved for Google
<a class=anchor href=#ip-addresses-reserved-for-google>#</a></h3><p>There are 4 reserved IP addresses (first two and last two in the CIDR range) in its primary IP range:</p><ol><li>network (first)</li><li>default gateway (second)</li><li>future use (second-to-last)</li><li>broadcast (last)</li></ol><p>There are no reserved IP addresses in the secondary IP range.</p><h2 id=routing-and-private-google-access>Routing and Private Google Access
<a class=anchor href=#routing-and-private-google-access>#</a></h2><p>Routes define the network traffic path from one destination to the other.</p><p>In a VPC route consists of a single CIDR destination and a single next hop.</p><p>All routes are stored in the routing table for the VPC.</p><p>Each packet leaving a VM is delivered to the next hop of an applicable route based on a routing order.</p><p>There are two routing types:</p><dl><dt>System generated</dt><dd>default, subnet route</dd><dt>Custom routes</dt><dd>static route (created manually), dynamic route (maintained automatically by cloud routers)</dd></dl><h3 id=default-route>Default route
<a class=anchor href=#default-route>#</a></h3><ul><li>path to the internet</li><li>path for <em>Private Google Access</em></li><li>can be deleted only by replacing with custom route</li><li>it has the lowest priority</li></ul><h3 id=subnet-route>Subnet route
<a class=anchor href=#subnet-route>#</a></h3><ul><li>define paths to each subnet in the VPC</li><li>each subnet has at least one subnet route whose destination matches the primary IP range of the subnet</li><li>when a subnet is created, a corresponding subnet route is created for both primary and secondary IP range</li><li>you cannot delete a subnet route unless you modify or delete the subnet; when you delete a subnet, all its subnet routes are deleted automatically</li></ul><h3 id=static-route>Static route
<a class=anchor href=#static-route>#</a></h3><ul><li>can use the next hop feature</li><li>can be created manually</li><li>static routes for the remote traffic selectors are created automatically when creating Cloud VPN tunnels</li></ul><p>Every route in the project must have a unique name.
Priorities are from <code>0</code> to <code>1000</code>, lower number have higher priority.</p><h3 id=dynamic-route>Dynamic route
<a class=anchor href=#dynamic-route>#</a></h3><ul><li>managed by one or more Cloud Routers</li><li>dynamically exchange routes between a VPC and on-premises networks</li><li>destination IP ranges outside the VPC network</li><li>used with dynamically routed VPNs and Interconnect</li></ul><h2 id=create-vpc-with-gcloud>Create VPC with gcloud
<a class=anchor href=#create-vpc-with-gcloud>#</a></h2><p>Create regional network with custom subnets.</p><p>Public subnet will have a default internet gateway.</p><p>Private subnet will have NAT gateway as its route.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>gcloud compute networks create main --bgp-routing-mode<span style=color:#f92672>=</span>regional --subnet-mode<span style=color:#f92672>=</span>custom
</span></span></code></pre></div><p>Add public subnet:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>gcloud compute networks subnets create public --range<span style=color:#f92672>=</span>10.0.0.0/24 --network<span style=color:#f92672>=</span>main --region<span style=color:#f92672>=</span>us-west2
</span></span></code></pre></div><p>Create private subnet:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>gcloud compute networks subnets create private --range<span style=color:#f92672>=</span>10.0.1.0/24 --network<span style=color:#f92672>=</span>main --region<span style=color:#f92672>=</span>us-west2 --enable-private-ip-google-access
</span></span></code></pre></div><p>Create cloud router:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>gcloud compute routers create router --network<span style=color:#f92672>=</span>main --region<span style=color:#f92672>=</span>us-west2
</span></span></code></pre></div><p>Create cloud NAT gateway and select IP ranges:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>gcloud compute routers nats create nat --router<span style=color:#f92672>=</span>router --region<span style=color:#f92672>=</span>us-west2 --nat-custom-subnet-ip-ranges<span style=color:#f92672>=</span>private --auto-allocate-nat-external-ips
</span></span></code></pre></div><h2 id=create-vpc-with-terraform>Create VPC with terraform
<a class=anchor href=#create-vpc-with-terraform>#</a></h2><p>First create a service account to be used with terraform and download credentials.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-tf data-lang=tf><span style=display:flex><span><span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;google&#34;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>credentials</span> <span style=color:#f92672>=</span> file(<span style=color:#e6db74>&#34;~/google-credentials.json&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>project</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;my-project&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>region</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;us-west2&#34;</span>
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># main VPC
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;google_compute_network&#34;</span> <span style=color:#e6db74>&#34;this&#34;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;main&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>auto_create_subnetworks</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># public subnet
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;google_compute_subnetwork&#34;</span> <span style=color:#e6db74>&#34;public&#34;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;public&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ip_cidr_range</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;10.0.0.0/24&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>region</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;us-west2&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>network</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>google_compute_network</span>.<span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>id</span>
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># private subnet
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;google_compute_subnetwork&#34;</span> <span style=color:#e6db74>&#34;public&#34;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;private&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ip_cidr_range</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;10.0.1.0/24&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>region</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;us-west2&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>network</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>google_compute_network</span>.<span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>id</span>
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># cloud router
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;google_compute_router&#34;</span> <span style=color:#e6db74>&#34;this&#34;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;router&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>network</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>google_compute_network</span>.<span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>id</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>bgp</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>asn</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>64514</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>advertise_mode</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;CUSTOM&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># NAT gateway
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;google_compute_router_nat&#34;</span> <span style=color:#e6db74>&#34;this&#34;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;nat&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>router</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>google_compute_router</span>.<span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>name</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>region</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>google_compute_router</span>.<span style=color:#a6e22e>this</span>.<span style=color:#a6e22e>region</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>nat_ip_allocate_option</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;AUTO_ONLY&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>source_subnetwork_ip_ranges_to_nat</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;LIST_OF_SUBNETWORKS&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>subnetwork</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>name</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;private&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>source_ip_ranges_to_nat</span> <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;ALL_IP_RAGES&#34;</span>]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=vpc-with-private-google-access>VPC with Private Google Access
<a class=anchor href=#vpc-with-private-google-access>#</a></h2><p>Private access = access to a VM without a public IP access.</p><p>Create VPC:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>gcloud compute networks create mynetwork --project<span style=color:#f92672>=</span>myproject --description<span style=color:#f92672>=</span>... --subnet-mode<span style=color:#f92672>=</span>custom --bgp-routing-mode<span style=color:#f92672>=</span>regional
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gcloud compute networks subnets create public --project<span style=color:#f92672>=</span>myproject --range<span style=color:#f92672>=</span>10.0.0.0/24 --network<span style=color:#f92672>=</span>mynetwork --region<span style=color:#f92672>=</span>us-east1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>gcloud compute networks subnets create private --project<span style=color:#f92672>=</span>myproject --range<span style=color:#f92672>=</span>10.0.5.0/24 --network<span style=color:#f92672>=</span>mynetwork --region<span style=color:#f92672>=</span>us-east4
</span></span></code></pre></div><p>Set up cloud storage:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># todo</span>
</span></span></code></pre></div><p>Set up VM instances:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>gcloud beta compute --project<span style=color:#f92672>=</span>myproject instances create public-instance --zone<span style=color:#f92672>=</span>us-east1-b --machine-type<span style=color:#f92672>=</span>e2-micro --subnet<span style=color:#f92672>=</span>public --network-tier<span style=color:#f92672>=</span>PREMIUM --maintenance-policy<span style=color:#f92672>=</span>MIGRATE --service-account<span style=color:#f92672>=</span>... --scopes<span style=color:#f92672>=</span>https://www.googleapis.com/auth/compute,https://www.googleapis.com/auth/servicecontrol,https://www.googleapis.com/auth/service.management.readonly,https://www.googleapis.com/auth/logging.write,https://www.googleapis.com/auth/monitoring.write,https://www.googleapis.com/auth/trace.append,https://www.googleapis.com/auth/devstorage.read_write --tags<span style=color:#f92672>=</span>public --image<span style=color:#f92672>=</span>debian-10-buster-v20200910 --image-project<span style=color:#f92672>=</span>debian-cloud --boot-disk-size<span style=color:#f92672>=</span>10GB --boot-disk-type<span style=color:#f92672>=</span>pd-standard --boot-disk-device-name<span style=color:#f92672>=</span>public-instance --no-shielded-secure-boot --shielded-vtpm --shielded-integrity-monitoring --labels<span style=color:#f92672>=</span>env<span style=color:#f92672>=</span>public --reservation-affinity<span style=color:#f92672>=</span>any
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># add another machine private-instance in the private subnet without public IP</span>
</span></span></code></pre></div><p>Add firewall rules allowing ssh and icmp access:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># todo</span>
</span></span></code></pre></div><p>On the public machine, check access to the storage:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>gsutil ls gs://mybucket-test-access
</span></span></code></pre></div><p>Check ssh from public to the private instance:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>gcloud compute ssh --project myproject --zone us-east4-c private-instance --internal-ip
</span></span></code></pre></div><p>Enable private gGoogle accees on the private network:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># todo</span>
</span></span></code></pre></div><h2 id=vpc-network-peering>VPC network peering
<a class=anchor href=#vpc-network-peering>#</a></h2><p>VPC peering is a service allowing two VPC networks to communicate privately without passing the traffic through the public Internet. (RFC 1918)</p><p>All the traffic stays within Google&rsquo;s network.</p><p>Peering can be established between the same or different projects and organizations.</p><p>As compared to VPN:</p><ul><li>reduces network latency</li><li>increases network security</li><li>reduces network costs</li></ul><p>Characteristics:</p><ul><li>peered networks remain administratively separate (routes, firewalls, vpn are applied separately)</li><li>connection established for each VPC separately, configuration on both sides has to match, each side can break the peering at any time</li><li>VPC peers always exchange all subnet routes</li><li>a VPC can peer with many networks, but quotas apply</li><li>CIDR range in one network cannot overlap with a static route in another network.</li><li>to allow ingress traffic from VM instances in a peer network, you must create ingress allow firewall rules (by default ingress traffic to VMs is blocked by the implied deny ingress rule)</li><li>transitive peering is not supported (networks must be peered directly to allow traffic)</li><li>you cannot use a tag or a service account in one peered network in another peered network</li><li>internal DNS is not accessible for compute engine in peered networks</li></ul></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/dpurge/dpurge.github.io/commit/0ad86147d9671b8b1289476c1e2721382f44f812 title='Last modified by David P | November 8, 2024' target=_blank rel=noopener><img src=/svg/calendar.svg class=book-icon alt=Calendar>
<span>November 8, 2024</span></a></div><div><a class="flex align-center" href=https://github.com/dpurge/dpurge.github.io/edit/main/content/docs/devops/gcp/vpc.md target=_blank rel=noopener><img src=/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#vpc>VPC</a><ul><li><a href=#vpc-network-subnets>VPC network subnets</a><ul><li><a href=#ip-addresses-reserved-for-google>IP addresses reserved for Google</a></li></ul></li><li><a href=#routing-and-private-google-access>Routing and Private Google Access</a><ul><li><a href=#default-route>Default route</a></li><li><a href=#subnet-route>Subnet route</a></li><li><a href=#static-route>Static route</a></li><li><a href=#dynamic-route>Dynamic route</a></li></ul></li><li><a href=#create-vpc-with-gcloud>Create VPC with gcloud</a></li><li><a href=#create-vpc-with-terraform>Create VPC with terraform</a></li><li><a href=#vpc-with-private-google-access>VPC with Private Google Access</a></li><li><a href=#vpc-network-peering>VPC network peering</a></li></ul></li></ul></nav></div></aside></main></body></html>