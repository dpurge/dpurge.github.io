<!doctype html><html lang=en-us dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="
  IAM
  #

IAM = Identity Access Management
Manages: Identity (who?) has role (what access) for which resource (or organization, project, folder).
Use the principle of least access.
Permissions not granted directly to the user.
Permissions are grouped into roles which are granted to the authenticated members.
IAM policy defines and enforces what roles are granted to which members.
This policy is attached to a resource.

  Policy architecture
  #

Policy:
  Metadata:
    etags: concurrency control
    version: specifies schema version
  Audit-Config: configures audit logging
  Binding:
    Condition: constrains binding
    Member: []
    Role:
      Permissions: []
Member is an identity that can access a resource.
Identity is an e-mail account associated with a user, service account or a Google group, a domain name associated with a GSuite or cloud identity domains."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:url" content="https://dpurge.github.io/docs/devops/gcp/iam/"><meta property="og:site_name" content="Notebook"><meta property="og:title" content="Notebook"><meta property="og:description" content="IAM # IAM = Identity Access Management
Manages: Identity (who?) has role (what access) for which resource (or organization, project, folder).
Use the principle of least access.
Permissions not granted directly to the user. Permissions are grouped into roles which are granted to the authenticated members.
IAM policy defines and enforces what roles are granted to which members. This policy is attached to a resource.
Policy architecture # Policy: Metadata: etags: concurrency control version: specifies schema version Audit-Config: configures audit logging Binding: Condition: constrains binding Member: [] Role: Permissions: [] Member is an identity that can access a resource. Identity is an e-mail account associated with a user, service account or a Google group, a domain name associated with a GSuite or cloud identity domains."><meta property="og:locale" content="en_us"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2024-11-04T16:38:39+01:00"><title>Iam | Notebook</title>
<link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.82c5dbd23447cee0b4c2aa3ed08ce0961faa40e1fa370eee4f8c9f02e0d46b5f.css integrity="sha256-gsXb0jRHzuC0wqo+0Izglh+qQOH6Nw7uT4yfAuDUa18=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script><script defer src=/en.search.min.146787b4064d3e2fa5aea91e6ee2c57fad2fb97548fe8168150c94b86da56175.js integrity="sha256-FGeHtAZNPi+lrqkebuLFf60vuXVI/oFoFQyUuG2lYXU=" crossorigin=anonymous></script><script defer src=/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js integrity="sha256-b2+Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC+NdcPIvZhzk=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>Notebook</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=Search aria-label=Search maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><input type=checkbox id=section-749497e15d97e060a688abbb8e008e3a class=toggle checked>
<label for=section-749497e15d97e060a688abbb8e008e3a class="flex justify-between"><a role=button>Devops</a></label><ul><li><input type=checkbox id=section-50999497f0e27fdba1c9e2dc3c444cf2 class=toggle>
<label for=section-50999497f0e27fdba1c9e2dc3c444cf2 class="flex justify-between"><a role=button>Ansible</a></label><ul><li><a href=/docs/devops/ansible/installation/>Installation</a></li></ul></li><li><input type=checkbox id=section-9c5f1eb01a8c593106ce220aa0920de8 class=toggle>
<label for=section-9c5f1eb01a8c593106ce220aa0920de8 class="flex justify-between"><a role=button>ArgoCD</a></label><ul><li><a href=/docs/devops/argo/installation/>Installation</a></li></ul></li><li><input type=checkbox id=section-4ebd45af817f2a6782d30223cfb30fb8 class=toggle>
<label for=section-4ebd45af817f2a6782d30223cfb30fb8 class="flex justify-between"><a href=/docs/devops/aws/>AWS</a></label><ul><li><a href=/docs/devops/aws/architecture/>Architecture</a></li><li><a href=/docs/devops/aws/aws-cli/>Aws CLI</a></li></ul></li><li><input type=checkbox id=section-b9ccc00dfaca5f6c9939761fd1f0d019 class=toggle>
<label for=section-b9ccc00dfaca5f6c9939761fd1f0d019 class="flex justify-between"><a role=button>Azure</a></label><ul><li><a href=/docs/devops/azure/exploring/>Exploring</a></li><li><a href=/docs/devops/azure/snippets/>Snippets</a></li></ul></li><li><input type=checkbox id=section-7db3ac4b38d865d04e7015c54e49703e class=toggle>
<label for=section-7db3ac4b38d865d04e7015c54e49703e class="flex justify-between"><a role=button>Blueprints</a></label><ul><li><a href=/docs/devops/blueprints/aws-3tier-webapp/>Aws 3tier Webapp</a></li><li><a href=/docs/devops/blueprints/aws-static-webapp/>Aws Static Webapp</a></li><li><a href=/docs/devops/blueprints/llm-closed-source/>Llm Closed Source</a></li></ul></li><li><input type=checkbox id=section-40d970db9e5f0628067d054bb2648776 class=toggle>
<label for=section-40d970db9e5f0628067d054bb2648776 class="flex justify-between"><a role=button>Docker</a></label><ul><li><a href=/docs/devops/docker/azure/>Azure</a></li><li><a href=/docs/devops/docker/basics/>Basics</a></li><li><a href=/docs/devops/docker/compose/>Compose</a></li><li><a href=/docs/devops/docker/installation/>Installation</a></li><li><a href=/docs/devops/docker/volumes/>Volumes</a></li></ul></li><li><input type=checkbox id=section-4443ca79b625be26a1316c658457726a class=toggle checked>
<label for=section-4443ca79b625be26a1316c658457726a class="flex justify-between"><a role=button>GCP</a></label><ul><li><a href=/docs/devops/gcp/cloud-shell/>Cloud Shell</a></li><li><a href=/docs/devops/gcp/definitions/>Definitions</a></li><li><a href=/docs/devops/gcp/functions/>Functions</a></li><li><a href=/docs/devops/gcp/gcloud/>Gcloud</a></li><li><a href=/docs/devops/gcp/gke-workload-identity/>Gke Workload Identity</a></li><li><a href=/docs/devops/gcp/gke/>Gke</a></li><li><a href=/docs/devops/gcp/iam/ class=active>Iam</a></li><li><a href=/docs/devops/gcp/vpc/>Vpc</a></li></ul></li><li><input type=checkbox id=section-cbbe11a9b81cf61e2a3ccb4b9b819485 class=toggle>
<label for=section-cbbe11a9b81cf61e2a3ccb4b9b819485 class="flex justify-between"><a role=button>Git</a></label><ul><li><a href=/docs/devops/git/branches/>Branches</a></li><li><a href=/docs/devops/git/configuration/>Configuration</a></li></ul></li><li><input type=checkbox id=section-4d3fc42527ded74d4ffcde26ba409017 class=toggle>
<label for=section-4d3fc42527ded74d4ffcde26ba409017 class="flex justify-between"><a role=button>Helm</a></label><ul><li><a href=/docs/devops/helm/charts/>Charts</a></li><li><a href=/docs/devops/helm/installation/>Installation</a></li></ul></li><li><input type=checkbox id=section-82a69a4645a3f6474bddc9249797cdcd class=toggle>
<label for=section-82a69a4645a3f6474bddc9249797cdcd class="flex justify-between"><a role=button>K3s</a></label><ul><li><a href=/docs/devops/k3s/k3d/>K3d</a></li><li><a href=/docs/devops/k3s/k3s/>K3s</a></li></ul></li><li><input type=checkbox id=section-6ccba73423854554c7b62c837d9f8480 class=toggle>
<label for=section-6ccba73423854554c7b62c837d9f8480 class="flex justify-between"><a href=/docs/devops/kubernetes/>Kubernetes</a></label><ul><li><a href=/docs/devops/kubernetes/azure-kubernetes/>Azure Kubernetes</a></li><li><a href=/docs/devops/kubernetes/deployment/>Deployment</a></li><li><a href=/docs/devops/kubernetes/design-patterns/>Design Patterns</a></li><li><a href=/docs/devops/kubernetes/ingress/>Ingress</a></li><li><a href=/docs/devops/kubernetes/k9s/>K9s</a></li><li><a href=/docs/devops/kubernetes/kubectl-config/>Kubectl Config</a></li><li><a href=/docs/devops/kubernetes/minikube/>Minikube</a></li><li><a href=/docs/devops/kubernetes/pod/>Pod</a></li><li><a href=/docs/devops/kubernetes/replica-set/>Replica Set</a></li><li><a href=/docs/devops/kubernetes/sealed-secrets/>Sealed Secrets</a></li><li><a href=/docs/devops/kubernetes/service/>Service</a></li><li><a href=/docs/devops/kubernetes/short-names/>Short Names</a></li></ul></li><li><input type=checkbox id=section-9b21c58f3ca215cb701a50b2be937f39 class=toggle>
<label for=section-9b21c58f3ca215cb701a50b2be937f39 class="flex justify-between"><a role=button>Linux</a></label><ul><li><a href=/docs/devops/linux/blocky/>Blocky</a></li><li><a href=/docs/devops/linux/caddy/>Caddy</a></li><li><a href=/docs/devops/linux/podman/>Podman</a></li><li><a href=/docs/devops/linux/screen/>Screen</a></li><li><a href=/docs/devops/linux/searxng/>Searxng</a></li><li><a href=/docs/devops/linux/setup/>Setup</a></li><li><a href=/docs/devops/linux/ubuntu/>Ubuntu</a></li></ul></li><li><input type=checkbox id=section-12b058c01cd4ee9c367229fa0a2ae9d5 class=toggle>
<label for=section-12b058c01cd4ee9c367229fa0a2ae9d5 class="flex justify-between"><a href=/docs/devops/macos/>MacOS</a></label><ul><li><a href=/docs/devops/macos/homebrew/>Homebrew</a></li><li><a href=/docs/devops/macos/java/>Java</a></li><li><a href=/docs/devops/macos/multipass/>Multipass</a></li><li><a href=/docs/devops/macos/python/>Python</a></li></ul></li><li><input type=checkbox id=section-20d009bc4ea64e02eccd031311200482 class=toggle>
<label for=section-20d009bc4ea64e02eccd031311200482 class="flex justify-between"><a href=/docs/devops/ollama/>Ollama</a></label><ul></ul></li><li><input type=checkbox id=section-1529bd8f1f24c7df03d4935e0825d068 class=toggle>
<label for=section-1529bd8f1f24c7df03d4935e0825d068 class="flex justify-between"><a role=button>Packer</a></label><ul><li><a href=/docs/devops/packer/installation/>Installation</a></li></ul></li><li><input type=checkbox id=section-9d3815e028aac865b69a582cd78417ca class=toggle>
<label for=section-9d3815e028aac865b69a582cd78417ca class="flex justify-between"><a href=/docs/devops/qemu/>QEmu</a></label><ul></ul></li><li><input type=checkbox id=section-790ea1f7a6ea27b27a7d6974cebdf176 class=toggle>
<label for=section-790ea1f7a6ea27b27a7d6974cebdf176 class="flex justify-between"><a href=/docs/devops/terraform/>Terraform</a></label><ul><li><a href=/docs/devops/terraform/aws/>Aws</a></li><li><a href=/docs/devops/terraform/basics/>Basics</a></li><li><a href=/docs/devops/terraform/installation/>Installation</a></li></ul></li><li><input type=checkbox id=section-0368c39eaef51566a54c8e3e2f9fa2c6 class=toggle>
<label for=section-0368c39eaef51566a54c8e3e2f9fa2c6 class="flex justify-between"><a role=button>Terragrunt</a></label><ul><li><a href=/docs/devops/terragrunt/basics/>Basics</a></li></ul></li><li><input type=checkbox id=section-9828b447b9f40bbd108cce3889e3b4b1 class=toggle>
<label for=section-9828b447b9f40bbd108cce3889e3b4b1 class="flex justify-between"><a role=button>Vagrant</a></label><ul><li><a href=/docs/devops/vagrant/installation/>Installation</a></li></ul></li><li><input type=checkbox id=section-942218419cbfe04f90f761579373a254 class=toggle>
<label for=section-942218419cbfe04f90f761579373a254 class="flex justify-between"><a role=button>Windows</a></label><ul><li><a href=/docs/devops/windows/ime/>Ime</a></li><li><a href=/docs/devops/windows/winget/>Winget</a></li></ul></li><li><input type=checkbox id=section-26337bdc1e916ea8b5d36fa54e142361 class=toggle>
<label for=section-26337bdc1e916ea8b5d36fa54e142361 class="flex justify-between"><a role=button>WSL</a></label><ul><li><a href=/docs/devops/wsl/installation/>Installation</a></li><li><a href=/docs/devops/wsl/ubuntu2004/>Ubuntu2004</a></li><li><a href=/docs/devops/wsl/ubuntu2204/>Ubuntu2204</a></li></ul></li></ul></li><li><input type=checkbox id=section-fd2a4e7f9ddea45452efb530b97de696 class=toggle>
<label for=section-fd2a4e7f9ddea45452efb530b97de696 class="flex justify-between"><a role=button>Other</a></label><ul><li><input type=checkbox id=section-6dd47201186b4d781af10ca590ffd0e8 class=toggle>
<label for=section-6dd47201186b4d781af10ca590ffd0e8 class="flex justify-between"><a role=button>Books</a></label><ul><li><a href=/docs/other/books/snippets/>Snippets</a></li></ul></li></ul></li><li><input type=checkbox id=section-28a50411accaecc16bc0763b9c190330 class=toggle>
<label for=section-28a50411accaecc16bc0763b9c190330 class="flex justify-between"><a role=button>Tools</a></label><ul><li><input type=checkbox id=section-90b144b61c72c3778fdd58ee23c315dd class=toggle>
<label for=section-90b144b61c72c3778fdd58ee23c315dd class="flex justify-between"><a role=button>AzCLI</a></label><ul></ul></li><li><input type=checkbox id=section-6cca59b4d0091eaef0a0b8007d6c65ac class=toggle>
<label for=section-6cca59b4d0091eaef0a0b8007d6c65ac class="flex justify-between"><a role=button>GraphViz</a></label><ul></ul></li><li><input type=checkbox id=section-27083e53c922ad66777d25d74697bf3f class=toggle>
<label for=section-27083e53c922ad66777d25d74697bf3f class="flex justify-between"><a role=button>Tesseract</a></label><ul></ul></li></ul></li><li><input type=checkbox id=section-5176c548812455d82028c9a17a394cc0 class=toggle>
<label for=section-5176c548812455d82028c9a17a394cc0 class="flex justify-between"><a role=button>Programming</a></label><ul><li><input type=checkbox id=section-61cd9064d82baabe56040da3bf4ce6ca class=toggle>
<label for=section-61cd9064d82baabe56040da3bf4ce6ca class="flex justify-between"><a role=button>Awk</a></label><ul><li><a href=/docs/programming/awk/basics/>Basics</a></li></ul></li><li><input type=checkbox id=section-dfae041bf653b237919ff5710c2fa09d class=toggle>
<label for=section-dfae041bf653b237919ff5710c2fa09d class="flex justify-between"><a role=button>Bash</a></label><ul><li><a href=/docs/programming/bash/basics/>Basics</a></li></ul></li><li><input type=checkbox id=section-ed13027fc146c77e05cbbb62f0d478e8 class=toggle>
<label for=section-ed13027fc146c77e05cbbb62f0d478e8 class="flex justify-between"><a role=button>Batch</a></label><ul><li><a href=/docs/programming/batch/basics/>Basics</a></li></ul></li><li><input type=checkbox id=section-eca9c52421e16e89406f17d6f0866bf7 class=toggle>
<label for=section-eca9c52421e16e89406f17d6f0866bf7 class="flex justify-between"><a role=button>C#</a></label><ul><li><a href=/docs/programming/csharp/basics/>Basics</a></li></ul></li><li><input type=checkbox id=section-56c1205d614eb59f3e7257046957b00b class=toggle>
<label for=section-56c1205d614eb59f3e7257046957b00b class="flex justify-between"><a role=button>Go</a></label><ul><li><a href=/docs/programming/go/basics/>Basics</a></li><li><a href=/docs/programming/go/cgi/>Cgi</a></li><li><a href=/docs/programming/go/installation/>Installation</a></li></ul></li><li><input type=checkbox id=section-4ca5fe0e612d1707016db6696a00da79 class=toggle>
<label for=section-4ca5fe0e612d1707016db6696a00da79 class="flex justify-between"><a role=button>Powershell</a></label><ul><li><a href=/docs/programming/powershell/azdo/>Azdo</a></li><li><a href=/docs/programming/powershell/basics/>Basics</a></li><li><a href=/docs/programming/powershell/snippets/>Snippets</a></li></ul></li><li><input type=checkbox id=section-fe4cd509d8ca1cec30ba72d484aacd57 class=toggle>
<label for=section-fe4cd509d8ca1cec30ba72d484aacd57 class="flex justify-between"><a role=button>Python</a></label><ul><li><a href=/docs/programming/python/basics/>Basics</a></li><li><a href=/docs/programming/python/environment/>Environment</a></li><li><a href=/docs/programming/python/installation/>Installation</a></li></ul></li><li><input type=checkbox id=section-a7951f4ea6115fa557f0ca9a84bc0cfc class=toggle>
<label for=section-a7951f4ea6115fa557f0ca9a84bc0cfc class="flex justify-between"><a role=button>SQLite</a></label><ul><li><a href=/docs/programming/sqlite/data/>Data</a></li></ul></li><li><input type=checkbox id=section-274a68fdfb79a16e14bd48bda2db09aa class=toggle>
<label for=section-274a68fdfb79a16e14bd48bda2db09aa class="flex justify-between"><a role=button>Typescript</a></label><ul><li><a href=/docs/programming/typescript/nodejs/>Nodejs</a></li></ul></li></ul></li></ul><ul><li><a href=/posts/>Blog</a></li><li><a href=https://github.com/dpurge/dpurge.github.io target=_blank rel=noopener>Github</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu>
</label><strong>Iam</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#iam>IAM</a><ul><li><a href=#policy-architecture>Policy architecture</a></li><li><a href=#policy-limitations>Policy limitations</a></li><li><a href=#policy-conditions>Policy conditions</a></li><li><a href=#audit-config-logs>Audit config logs</a></li><li><a href=#edit-policy>Edit policy</a></li><li><a href=#service-accounts>Service accounts</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=iam>IAM
<a class=anchor href=#iam>#</a></h1><p>IAM = Identity Access Management</p><p>Manages: <em>Identity</em> (who?) has <em>role</em> (what access) for which <em>resource</em> (or organization, project, folder).</p><p>Use the principle of least access.</p><p>Permissions not granted directly to the user.
Permissions are grouped into roles which are granted to the authenticated members.</p><p>IAM policy defines and enforces what roles are granted to which members.
This policy is attached to a resource.</p><h2 id=policy-architecture>Policy architecture
<a class=anchor href=#policy-architecture>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>Policy</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>Metadata</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>etags</span>: <span style=color:#ae81ff>concurrency control</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>version</span>: <span style=color:#ae81ff>specifies schema version</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>Audit-Config</span>: <span style=color:#ae81ff>configures audit logging</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>Binding</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>Condition</span>: <span style=color:#ae81ff>constrains binding</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>Member</span>: []
</span></span><span style=display:flex><span>    <span style=color:#f92672>Role</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>Permissions</span>: []
</span></span></code></pre></div><p>Member is an identity that can access a resource.
Identity is an e-mail account associated with a user, service account or a Google group, a domain name associated with a GSuite or cloud identity domains.</p><dl><dt>Google Account</dt><dd>any email address that is associated with a Google Account, either gmail.com or other domains</dd><dt>Service Account</dt><dd>an account for an application instead of an individual end user</dd><dt>Google Group</dt><dd>a named collection of Google Accounts and service accounts</dd><dt>G Suite Domain</dt><dd>Google Accounts created in an organization&rsquo;s G Suite account</dd><dt>Cloud Identity Domain</dt><dd>Google Accounts in an organization that are not tied to any G Suite applications or features</dd><dt>AllAUthenticatedUsers</dt><dd>a special identifier that represents all service accounts and all users on the internet who have authenticated with a Google Account</dd><dt>AllUsers</dt><dd>a special identifier that represents anyone, including authenticated and unauthenticated users</dd></dl><p>Permissions determine what operations are allowed on a resource.
They correspond one-to-one with REST API methods.
Permissions are not granted to users directly.
You grant roles which contain one or more permissions.
Permissions are represented as <em>{service}.{resource}.{verb}</em>, eg. <code>compute.instances.list</code></p><p>Roles are collections of permissions.
You cannot grant a permission to the user directly.
You grant a role to a user and all the permissions that the role contains.</p><p>There are three types of roles:</p><dl><dt>Primitive roles</dt><dd><code>Owner</code>, <code>Editor</code>, <code>Viewer</code>; historically available prior to IAM; avoid using these roles; can only be grated from a Google console</dd><dt>Predefined roles</dt><dd>finer-grained access control than the primitive roles; created and maintained by Google</dd><dt>Custom roles</dt><dd>tailor permissions to the needs of your organization; not maintained by Google; cannot be created at folder level; by default only project owner can create new roles</dd></dl><p>Custom role <em>launch stages</em>:</p><ul><li>alpha = in testing</li><li>beta = tested and awaiting approval</li><li>ga = generally available</li></ul><p>Condition is a logic expression used to define and enforce attribute-based access control for Google Cloud resources.
Conditions allow you to choose granting resource access to identities only if configured conditions are met.
When a contition exists, the access request is only granted if the condition expression evaluates to <code>true</code>.</p><p>Metadata etags prevent a race condition when updating the policy.</p><p>Metadata version is used to avoid breaking existing integrations that rely on consistency in the policy structure when new policy schema versions are introduced.</p><p>Audit config configures audit logging; determines which permission types are logged and what identities are exempted from logging.</p><p>Resource inherit the policies of all their parent resources.
The policy is a union of a resource direct policy and the policies of all its parents in the resource hierarchy (organization, folders, project, resource).</p><p>Example policy statement (can be expressed in JSON or YAML):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;bindings&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;role&#34;</span>: <span style=color:#e6db74>&#34;roles/storage.admin&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;members&#34;</span>: [
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;user:example@gmail.com&#34;</span>
</span></span><span style=display:flex><span>            ]
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;role&#34;</span>: <span style=color:#e6db74>&#34;roles/storage.objectViewer&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;members&#34;</span>: [
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#34;user:other@gmail.com&#34;</span>
</span></span><span style=display:flex><span>            ],
</span></span><span style=display:flex><span>            <span style=color:#f92672>&#34;condition&#34;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;title&#34;</span>: <span style=color:#e6db74>&#34;Expires_January_1_2021&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;description&#34;</span>: <span style=color:#e6db74>&#34;Do not grant access after Jan 2021&#34;</span>,
</span></span><span style=display:flex><span>                <span style=color:#f92672>&#34;expression&#34;</span>: <span style=color:#e6db74>&#34;request.time &lt; timestamp(&#39;2021-01-01T00:00:00.000Z&#39;)&#34;</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;etag&#34;</span>: <span style=color:#e6db74>&#34;BeEEja0YfWJ=&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;version&#34;</span>: <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Querying for policies:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>gcloud projects get-iam-policy <span style=color:#f92672>{</span>project-id<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>gcloud resource-manager folders get-iam-policy <span style=color:#f92672>{</span>folder-id<span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>gcloud organizations get-iam-policy <span style=color:#f92672>{</span>organization-id<span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Policy versions:</p><dl><dt>version 1</dt><dd>default; supports binding one role to one or more members; does not support conditional role bindings</dd><dt>version 2</dt><dd>for Google&rsquo;s internal use</dd><dt>version 3</dt><dd>introduces condition statement</dd></dl><h2 id=policy-limitations>Policy limitations
<a class=anchor href=#policy-limitations>#</a></h2><ul><li>each resource can only have one policy (including organizations, projects, folders)</li><li>max 1500 members or 250 Google groups per policy</li><li>up to 7 minutes for a policy change to fully propagate across GCP</li><li>max 100 conditional role bindings per policy</li></ul><h2 id=policy-conditions>Policy conditions
<a class=anchor href=#policy-conditions>#</a></h2><p>Condition attributes are either based on resource or based on details of the request, eg. timestamp or originating/destination IP address</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>bindings</span>:
</span></span><span style=display:flex><span>- <span style=color:#f92672>members</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>user:me@gmail.com</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>role</span>: <span style=color:#ae81ff>roles/owner</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>members</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>user:example@gmail.com</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>role</span>: <span style=color:#ae81ff>roles/storage.objectViewer</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>condition</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>title</span>: <span style=color:#ae81ff>Business_hours_access</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>description</span>: <span style=color:#ae81ff>Business hours access Monday-Friday</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>expression</span>: <span style=color:#ae81ff>request.time.getHours(&#34;America/Toronto&#34;) &gt;= 9 &amp;&amp;</span>
</span></span><span style=display:flex><span>                <span style=color:#ae81ff>request.time.getHours(&#34;America/Toronto&#34;) &lt;= 17 &amp;&amp;</span>
</span></span><span style=display:flex><span>                <span style=color:#ae81ff>// 0 = Sunday, 6 = Saturday</span>
</span></span><span style=display:flex><span>                <span style=color:#ae81ff>request.time.getDayOfWeek(&#34;America/Toronto&#34;) &gt;= 1 &amp;&amp;</span>
</span></span><span style=display:flex><span>                <span style=color:#ae81ff>request.time.getDayOfWeek(&#34;America/Toronto&#34;) &lt;= 5</span>
</span></span><span style=display:flex><span><span style=color:#f92672>etag</span>: <span style=color:#ae81ff>xxx</span>
</span></span><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#ae81ff>3</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>bindings</span>:
</span></span><span style=display:flex><span>- <span style=color:#f92672>members</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>user:me@gmail.com</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>role</span>: <span style=color:#ae81ff>roles/owner</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>members</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>group:developer@mydomain.com</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>role</span>: <span style=color:#ae81ff>roles/compute.instanceAdmin</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>condition</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>title</span>: <span style=color:#ae81ff>Dev_only_access</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>description</span>: <span style=color:#ae81ff>Only access to development* VMs</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>expression</span>: <span style=color:#ae81ff>(resource.type == &#39;compute.googleapis.com/Disk&#39; &amp;&amp;</span>
</span></span><span style=display:flex><span>                <span style=color:#ae81ff>resource.name.startsWith(&#39;projects/project-my-example/regions/us-central1/disks/development&#39;)) ||</span>
</span></span><span style=display:flex><span>                <span style=color:#ae81ff>(resource.type == &#39;compute.googleapis.com/Instance&#39; &amp;&amp;</span>
</span></span><span style=display:flex><span>                <span style=color:#ae81ff>resource.name.startsWith(&#39;projects/project-my-example/zones/us-central1-a/instances/development&#39;)) ||</span>
</span></span><span style=display:flex><span>                <span style=color:#ae81ff>(resource.type != &#39;compute.googleapis.com/Instance&#39; &amp;&amp;</span>
</span></span><span style=display:flex><span>                <span style=color:#ae81ff>resource.type != &#39;compute.googleapis.com/Disk&#39;)</span>
</span></span><span style=display:flex><span><span style=color:#f92672>etag</span>: <span style=color:#ae81ff>xxx</span>
</span></span><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#ae81ff>3</span>
</span></span></code></pre></div><p>Condition limitations:</p><ul><li>limited to specific services</li><li>primitive roles are not supported</li><li>members cannot be <code>allUsers</code> or <code>allAuthenticatedUsers</code></li><li>max 100 conditional role bindings per policy</li><li>max 20 role bindings for the same role and the same member</li></ul><h2 id=audit-config-logs>Audit config logs
<a class=anchor href=#audit-config-logs>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>auditConfigs</span>:
</span></span><span style=display:flex><span>- <span style=color:#f92672>auditLogConfigs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>logType</span>: <span style=color:#ae81ff>DATA_READ</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>logType</span>: <span style=color:#ae81ff>ADMIN_READ</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>logType</span>: <span style=color:#ae81ff>DATA_WRITE</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>service</span>: <span style=color:#ae81ff>allServices</span>
</span></span><span style=display:flex><span>- <span style=color:#f92672>auditLogConfigs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>exmptedMembers</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>me@gmail.com</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>logType</span>: <span style=color:#ae81ff>ADMIN_READ</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>service</span>: <span style=color:#ae81ff>storage.googleapis.com</span>
</span></span></code></pre></div><h2 id=edit-policy>Edit policy
<a class=anchor href=#edit-policy>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>gcloud projects get-iam-policy <span style=color:#f92672>{</span>project-id<span style=color:#f92672>}</span> &gt; new-policy.yaml
</span></span><span style=display:flex><span>gcloud projects set-iam-policy <span style=color:#f92672>{</span>project-id<span style=color:#f92672>}</span> new-policy.yaml
</span></span></code></pre></div><p>Make sure that etag is correct, or you will not be able to set the new policy.</p><p>Granting access from the command line:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>gcloud projects add-iam-policy-binding <span style=color:#f92672>{</span>project-id<span style=color:#f92672>}</span> --member user:somebody@gmail.com --role roles/storage.admin
</span></span></code></pre></div><h2 id=service-accounts>Service accounts
<a class=anchor href=#service-accounts>#</a></h2><p>A service account is both an identity and a resource.</p><p>Service account is a special kind of account used by an application or a virtual machine instance and not a person.
It represents a non-human user.
A service account is identified by an email address which is unique.</p><p>There are three service account types:</p><dl><dt>User-managed</dt><dd>user created; you choose the name; default quota 100 user accounts per project</dd><dt>Default</dt><dd>some services automatically create user-managed service account with <em>Editor</em> role for the project; Google recommends revoking Editor role manually</dd><dt>Google-managed</dt><dd>created and managed by Google; used by Google services; some visible, some hidden; name ends with &ldquo;Service Agent&rdquo; or &ldquo;Service Account&rdquo;; do not change or revoke roles for these accounts</dd></dl><p>Email format for user mananaged service accounts: <code>{service-name}@{project-id}.iam.gserviceaccount.com</code></p><p>Email formats for the default service accounts:</p><ul><li><code>{project-id}@appspot.gserviceaccount.com</code></li><li><code>{project-number}-compute@developer.gserviceaccount.com</code></li></ul><p>Service accounts authenticate using keys.
Each service has two sets of private and public RSA keypairs.</p><p>There are Google managed and user managed keys.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>gcloud iam service-accounts list
</span></span><span style=display:flex><span>gcloud iam service-accounts create sa-example --display-name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;sa-example&#39;</span>
</span></span><span style=display:flex><span>gcloud projects add-iam-policy-binding <span style=color:#f92672>{</span>project-name<span style=color:#f92672>}</span> --member <span style=color:#e6db74>&#39;serviceAccount:{account-name}@{project-name}.iam.gserviceaccount.com&#39;</span> --role <span style=color:#e6db74>&#39;roles/storage.objectViewer&#39;</span>
</span></span><span style=display:flex><span>gcloud compute instances stop instance-1 --zone us-central1-a
</span></span><span style=display:flex><span>gcloud compute instances set-service-account instance-1 --zone us-central1-a --service-account sa-example@<span style=color:#f92672>{</span>project-name<span style=color:#f92672>}</span>.iam.gserviceaccount.com
</span></span><span style=display:flex><span>gcloud compute instances start instance-1 --zone us-central1
</span></span></code></pre></div></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/dpurge/dpurge.github.io/commit/045eb0a48df7d1d78d75b057fd54ffbdce8fca52 title='Last modified by David P | November 4, 2024' target=_blank rel=noopener><img src=/svg/calendar.svg class=book-icon alt=Calendar>
<span>November 4, 2024</span></a></div><div><a class="flex align-center" href=https://github.com/dpurge/dpurge.github.io/edit/main/content/docs/devops/gcp/iam.md target=_blank rel=noopener><img src=/svg/edit.svg class=book-icon alt=Edit>
<span>Edit this page</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#iam>IAM</a><ul><li><a href=#policy-architecture>Policy architecture</a></li><li><a href=#policy-limitations>Policy limitations</a></li><li><a href=#policy-conditions>Policy conditions</a></li><li><a href=#audit-config-logs>Audit config logs</a></li><li><a href=#edit-policy>Edit policy</a></li><li><a href=#service-accounts>Service accounts</a></li></ul></li></ul></nav></div></aside></main></body></html>